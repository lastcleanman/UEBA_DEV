services:
  # ----------------------------------------
  # 1. ğŸš€ ì‹ ê·œ UEBA Core Engine (ìš°ë¦¬ê°€ ë§Œë“  ê²ƒ)
  # ----------------------------------------
  ueba-engine-dev:
    build: .
    image: ueba-engine:dev
    container_name: ueba-engine-dev
    restart: always             
    user: root                  
    volumes:
      - ./:/UEBA_DEV
    working_dir: /UEBA_DEV
    environment:
      - TZ=Asia/Seoul
      - PYTHONPATH=/UEBA_DEV
    command: >
      bash -c "python3 /UEBA_DEV/core/engine.py"
    networks:
      - ueba-network

  # ----------------------------------------
  # 2. ğŸ—„ï¸ ë°±ì—”ë“œ ì¸í”„ë¼ (DB & Search)
  # ----------------------------------------
  ueba-postgres:
    image: postgres:15
    container_name: ueba-postgres
    restart: always
    ports:
      - "5433:5432"
    environment:
      - POSTGRES_USER=admin       
      - POSTGRES_PASSWORD=Suju!0901   
      - POSTGRES_DB=ueba_db
    volumes: 
      - ./postgres_data:/var/lib/postgresql/data
    networks:
      - ueba-network

  ueba-elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.10.2
    container_name: ueba-elasticsearch
    restart: always
    ports:
      - "9200:9200"
      - "9300:9300"
    environment:
      - discovery.type=single-node
      - xpack.security.enabled=false  # ë¡œì»¬ ê°œë°œ í¸ì˜ì„±ì„ ìœ„í•´ SSL / ì¸ì¦ ë³´ì•ˆ í•´ì œ ( HTTP í†µì‹  )
      - ES_JAVA_OPTS=-Xms1g -Xmx1g
    networks:
      - ueba-network

  ueba-kibana:
    image: docker.elastic.co/kibana/kibana:8.10.2
    container_name: ueba-kibana
    restart: always
    ports:
      - "5601:5601"
    environment:
      - ELASTICSEARCH_HOSTS=http://ueba-elasticsearch:9200
    depends_on:
      - ueba-elasticsearch
    networks:
      - ueba-network
# ----------------------------------------
  # 3. ğŸŒ ì›¹ ì„œë¹„ìŠ¤ (Frontend & Backend)
  # ----------------------------------------
  ueba-backend:
    image: python:3.10-slim
    container_name: ueba-backend
    restart: always
    ports:
      - "8000:8000"
    volumes:
      - ./:/UEBA_DEV
    working_dir: /UEBA_DEV/backend
    command: bash -c "pip install fastapi uvicorn pandas pyarrow && uvicorn main:app --host 0.0.0.0 --port 8000"
    networks:
      - ueba-network

  ueba-frontend:
    image: node:22-alpine
    container_name: ueba-frontend
    restart: always
    ports:
      - "5173:5173"
    volumes:
      - ./frontend:/app
    working_dir: /app
    command: sh -c "npm install && npm run dev -- --host 0.0.0.0"
    networks:
      - ueba-network

networks:
  ueba-network:
    driver: bridge