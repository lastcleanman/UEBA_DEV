services:
  # 1. IAM 및 자산 정보 저장용 (PostgreSQL)
  ueba-postgres:
    image: postgres:15
    container_name: ueba-postgres
    restart: always
    ports:
      - "5433:5432"
    environment:
      - POSTGRES_USER=admin
      - POSTGRES_PASSWORD=Suju!0901
      - POSTGRES_DB=ueba_db
    volumes:
      - ./postgres_data:/var/lib/postgresql/data
    networks:
      - ueba-network

  # 2. 대용량 로그 검색 및 분석용 (Elasticsearch)
  ueba-elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.10.2
    container_name: ueba-elasticsearch
    restart: always
    ports:
      - "9200:9200"
      - "9300:9300"
    environment:
      - discovery.type=single-node
      - xpack.security.enabled=false
      - ES_JAVA_OPTS=-Xms1g -Xmx1g
    networks:
      - ueba-network

  # 3. 데이터 시각화 도구 (Kibana)
  ueba-kibana:
    image: docker.elastic.co/kibana/kibana:8.10.2
    container_name: ueba-kibana
    restart: always
    ports:
      - "5601:5601"
    environment:
      - ELASTICSEARCH_HOSTS=http://ueba-elasticsearch:9200
    depends_on:
      - ueba-elasticsearch
    networks:
      - ueba-network

  # ⭐️ 4. 분산 데이터 처리 엔진 (PySpark Master)
  ueba-spark:
    image: apache/spark:3.4.1
    container_name: ueba-spark
    restart: always
    environment:
      - SPARK_MODE=master
      - SPARK_RPC_AUTHENTICATION_ENABLED=no
      - SPARK_RPC_ENCRYPTION_ENABLED=no
      - SPARK_LOCAL_STORAGE_ENCRYPTION_ENABLED=no
      - SPARK_SSL_ENABLED=no
    command: /opt/spark/bin/spark-class org.apache.spark.deploy.master.Master
    ports:
      - "8080:8080" # Spark Master Web UI 
      - "7077:7077" # Spark Master RPC Port
    volumes:
      - ./:/UEBA_DEV  # 엔진과 동일한 경로를 마운트하여 파케이(Parquet) 파일 공유
    networks:
      - ueba-network

  # ⭐️ 5. 통합 Backend (API + Engine + Parser + Log Generator)
  ueba-backend:
    build: 
      context: ./backend
      dockerfile: Dockerfile
    container_name: ueba-backend
    restart: always
    ports:
      - "8000:8000"
      - "4040:4040"
    volumes:
      - ./:/UEBA_DEV
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
    depends_on:
      - ueba-spark
    networks:
      - ueba-network

  # 6. Frontend (React)
  ueba-frontend:
    image: node:22-alpine
    container_name: ueba-frontend
    restart: always
    ports:
      - "5173:5173"
    volumes:
      - ./frontend:/app
    working_dir: /app
    command: sh -c "npm install && npm run dev -- --host 0.0.0.0"
    networks:
      - ueba-network

networks:
  ueba-network:
    driver: bridge